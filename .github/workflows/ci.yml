name: MATLAB FSM CI

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main ]
    paths:
      - '2503-mpw1/*.m'
      - '2503-mpw1/FSMConv2Bin_new_v3.py'

  pull_request_target:
    branches: [ main ]
    paths:
      - '2503-mpw1/*.m'
      - '2503-mpw1/FSMConv2Bin_new_v3.py'

jobs:
  build-and-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Run FSM conversion script
      run: |
        echo "Running FSM conversion..."

        python 2503-mpw1/FSMConv2Bin_new_v3.py \
          2503-mpw1/StateM_MPW1_2503_hb_CBW20.m \
          2503-mpw1/StateM_MPW1_2503_hb_CBW40.m \
          2503-mpw1/StateM_MPW1_2503_hb_CBW80_160.m \
          2503-mpw1/StateM_MPW1_2503_lb_CBW20.m \
          2503-mpw1/StateM_MPW1_2503_lb_CBW40.m

        echo "Script finished successfully."

    - name: Collect bin files and generate md5 summary
      run: |
        echo "Searching generated directories..."

        mkdir -p ci_artifacts
        touch ci_artifacts/md5_summary.txt

        for dir in AgcGen_*; do
          if [ -d "$dir" ]; then
            echo "Processing $dir"

            for binfile in $dir/*.bin; do
              if [ -f "$binfile" ]; then
                md5=$(md5sum "$binfile" | awk '{print $1}')
                echo "$binfile  $md5" >> ci_artifacts/md5_summary.txt
              fi
            done

            cp -r "$dir" ci_artifacts/
          fi
        done

        echo "MD5 Summary:"
        cat ci_artifacts/md5_summary.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fsm-build-output
        path: ci_artifacts

    - name: Comment MD5 summary to PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const md5 = fs.readFileSync('ci_artifacts/md5_summary.txt', 'utf8');
    
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "## âœ… BIN MD5 Summary\n\n```\n" + md5 + "\n```"
          });